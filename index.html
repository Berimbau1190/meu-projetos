<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProjectHub Offline</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    /* RESET */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f2f4f8; color: #333; }

    /* LOGIN */
    .login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #0f172a, #1e293b); color: white; }
    .login-box { background: #1e293b; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .login-box h2 { margin-bottom: 20px; font-size: 26px; color: #38bdf8; }
    .login-box input { width: 100%; margin: 10px 0; padding: 12px; border-radius: 6px; border: none; background: #334155; color: white; }
    .login-box button { width: 100%; padding: 12px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: background 0.3s ease; }
    .login-box button:hover { background: #16a34a; }
    .info { font-size: 13px; color: #94a3b8; margin-top: 15px; }

    /* HEADER */
    header { background: #1f2937; color: white; display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    header h1 { font-size: 22px; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-info button { background: #ef4444; color: white; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer; }
    .user-info button:hover { background: #dc2626; }

    /* CONTE√öDO PRINCIPAL */
    .container { max-width: 1000px; margin: 30px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.05); }
    .container h2 { margin-bottom: 20px; color: #1f2937; }

    /* FORMUL√ÅRIO */
    form label { display: block; margin-bottom: 10px; font-weight: bold; color: #111827; }
    form input, form textarea, form select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }
    .row { display: flex; gap: 20px; margin-top: 10px; }
    form button { margin-top: 20px; padding: 12px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.3s ease; }
    form button:hover { background-color: #2563eb; }

    /* A√á√ïES DE CATEGORIA */
    .category-actions { margin-top: 8px; display: flex; gap: 10px; }
    .category-actions button { font-size: 12px; padding: 6px 10px; background: #e2e8f0; color: #1f2937; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
    .category-actions button:hover { background: #cbd5e1; }

    /* BOT√ïES DE IMPORTA√á√ÉO */
    .import-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
    .import-buttons button { padding: 10px 15px; border: none; background: #64748b; color: white; border-radius: 6px; cursor: pointer; }
    .import-buttons button:hover { background: #475569; }

    /* GRID DE PROJETOS */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
    .project-card { background: #f9fafb; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0; box-shadow: 0 3px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .project-card:hover { transform: scale(1.02); box-shadow: 10px 10px 30px green; }
    .project-card h3 { font-size: 18px; margin-bottom: 10px; }
    .project-card p { font-size: 14px; margin: 5px 0; }
    .project-card em { color: #6b7280; }

    /* MINIATURA DE IMAGEM */
    .project-card img { width: 100%; max-height: 160px; object-fit: cover; border-radius: 6px; margin-bottom: 10px; }

    /* VISUALIZADOR 3D */
    .project-card model-viewer { width: 100%; height: 160px; background: #e5e7eb; border-radius: 6px; margin-bottom: 10px; }

    /* Bot√µes do Card */
    .project-card button { padding: 8px 12px; margin-top: 10px; margin-right: 6px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 13px; }
    .download-btn { background: #3b82f6; } .download-btn:hover { background: #2563eb; }
    .edit-btn { background: #10b981; } .edit-btn:hover { background: #059669; }
    .delete-btn { background: #ef4444; } .delete-btn:hover { background: #dc2626; }

    /* FOOTER */
    footer { text-align: center; padding: 20px; color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <h2>ProjectHub</h2>
      <input type="text" id="username" placeholder="Usu√°rio" />
      <input type="password" id="password" placeholder="Senha" />
      <input type="password" id="confirmPassword" placeholder="Confirmar senha (apenas cadastro)" />
      <input type="text" id="recoveryKey" placeholder="Palavra-chave de recupera√ß√£o" />
      <button id="loginBtn">Entrar / Criar conta</button>
      <button id="recoverBtn">Recuperar senha</button>
      <p class="info">Crie uma conta ou recupere senha com a palavra-chave.</p>
    </div>
  </div>

  <!-- APP -->
  <div id="mainApp" style="display: none;">
    <header>
      <h1>ProjectHub Offline</h1>
      <div class="user-info">
        <span id="currentUser"></span>
        <button id="logoutBtn">Sair</button>
      </div>
    </header>

    <main class="container">
      <!-- FORMUL√ÅRIO -->
      <section class="form-section">
        <h2>Adicionar novo projeto</h2>
        <form id="projectForm">
          <label>T√≠tulo
            <input type="text" id="title" required />
          </label>

          <label>Autor
            <input type="text" id="author" required />
          </label>

          <label>Descri√ß√£o
            <textarea id="description" rows="3"></textarea>
          </label>

          <div class="row">
            <label>Categoria
              <input list="categoryList" id="category" placeholder="Digite ou selecione" required />
              <datalist id="categoryList"></datalist>
              <div class="category-actions">
                <button type="button" id="editCategoryBtn">‚úèÔ∏è Editar</button>
                <button type="button" id="deleteCategoryBtn">üóëÔ∏è Excluir</button>
              </div>
            </label>

            <label>Formato
              <select id="format">
                <option value="2D">2D</option>
                <option value="3D">3D</option>
              </select>
            </label>
          </div>

          <label>Arquivo
            <input type="file" id="fileInput" accept=".jpg,.png,.jpeg,.gif,.glb,.gltf,.zip,.html,.css,.js" />
          </label>

          <button type="submit">Salvar projeto</button>
        </form>
      </section>

      <!-- PROJETOS -->
      <section class="projects-section">
        <h2>Seus projetos</h2>

        <div class="import-buttons">
          <button id="importBtn">üìÇ Importar projeto de arquitetura</button>
          <button id="importEngBtn">‚öôÔ∏è Importar projeto de engenharia</button>
        </div>

        <input type="file" id="importFile" style="display:none" />
        <div id="projectsGrid" class="grid"></div>
      </section>
    </main>

    <footer>¬© 2025 ProjectHub Offline ‚Äî todos os direitos reservados.</footer>
  </div>

  <script>
    let currentUser = null;

    // ELEMENTOS
    const loginScreen = document.getElementById("loginScreen");
    const mainApp = document.getElementById("mainApp");
    const loginBtn = document.getElementById("loginBtn");
    const recoverBtn = document.getElementById("recoverBtn");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confirmPassword");
    const recoveryKeyInput = document.getElementById("recoveryKey");
    const currentUserSpan = document.getElementById("currentUser");
    const logoutBtn = document.getElementById("logoutBtn");

    // LOGIN / CADASTRO
    loginBtn.addEventListener("click", () => {
      const user = usernameInput.value.trim();
      const pass = passwordInput.value.trim();
      const confirmPass = confirmPasswordInput.value.trim();
      const recoveryKey = recoveryKeyInput.value.trim();
      if (!user || !pass || !recoveryKey) return alert("Preencha todos os campos.");
      let users = JSON.parse(localStorage.getItem("users") || "{}");
      if (!users[user]) {
        if (pass !== confirmPass) return alert("Senha e confirma√ß√£o n√£o coincidem.");
        users[user] = { password: pass, recoveryKey };
        localStorage.setItem("users", JSON.stringify(users));
        alert("Conta criada com sucesso!");
      } else { if (users[user].password !== pass) return alert("Senha incorreta!"); }
      currentUser = user;
      localStorage.setItem("loggedUser", user);
      showApp();
    });

    // RECUPERAR SENHA
    recoverBtn.addEventListener("click", () => {
      const user = usernameInput.value.trim();
      const key = recoveryKeyInput.value.trim();
      if (!user || !key) return alert("Preencha usu√°rio e palavra-chave.");
      let users = JSON.parse(localStorage.getItem("users") || "{}");
      if (!users[user]) return alert("Usu√°rio n√£o encontrado.");
      if (users[user].recoveryKey !== key) return alert("Palavra-chave incorreta.");
      const newPass = prompt("Digite a nova senha:");
      if (!newPass) return;
      const confirmPass = prompt("Confirme a nova senha:");
      if (newPass !== confirmPass) return alert("Senhas n√£o coincidem.");
      users[user].password = newPass;
      localStorage.setItem("users", JSON.stringify(users));
      alert("Senha alterada com sucesso!");
    });

    // MOSTRAR APP
    function showApp() {
      loginScreen.style.display = "none";
      mainApp.style.display = "block";
      currentUserSpan.textContent = "Usu√°rio: " + currentUser;
      loadProjects();
    }

    // LOGOUT
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("loggedUser");
      mainApp.style.display = "none";
      loginScreen.style.display = "flex";
      currentUser = null;
    });

    // AUTO LOGIN
    window.addEventListener("load", () => {
      const logged = localStorage.getItem("loggedUser");
      if (logged) { currentUser = logged; showApp(); }
    });

    // ==================== PROJETOS ====================
    const projectForm = document.getElementById("projectForm");
    const projectsGrid = document.getElementById("projectsGrid");
    const fileInput = document.getElementById("fileInput");
    const importBtn = document.getElementById("importBtn");
    const importEngBtn = document.getElementById("importEngBtn");
    const importFile = document.getElementById("importFile");

    projectForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const title = document.getElementById("title").value;
      const author = document.getElementById("author").value;
      const description = document.getElementById("description").value;
      const category = document.getElementById("category").value;
      const format = document.getElementById("format").value;
      const file = fileInput.files[0];
      if (!file) return alert("Selecione um arquivo!");
      const reader = new FileReader();
      reader.onload = () => {
        const project = { id: Date.now(), title, author, description, category, format, fileName: file.name, fileData: reader.result };
        saveProject(project);
        projectForm.reset();
      };
      reader.readAsDataURL(file);
    });

    function saveProject(project) {
      let allProjects = JSON.parse(localStorage.getItem("projects") || "{}");
      if (!allProjects[currentUser]) allProjects[currentUser] = [];
      allProjects[currentUser].push(project);
      localStorage.setItem("projects", JSON.stringify(allProjects));
      loadProjects();
    }

    function loadProjects() {
      projectsGrid.innerHTML = "";
      const allProjects = JSON.parse(localStorage.getItem("projects") || "{}");
      const projects = allProjects[currentUser] || [];

      projects.forEach((p) => {
        const div = document.createElement("div");
        div.className = "project-card";
        div.innerHTML = `
          <h3>${p.title}</h3>
          <p><strong>Autor:</strong> ${p.author}</p>
          <p>${p.description}</p>
          <p><em>${p.category} - ${p.format}</em></p>
          <button class="download-btn">Baixar</button>
          <button class="edit-btn">Editar</button>
          <button class="delete-btn">Excluir</button>
        `;

        div.querySelector(".download-btn").onclick = () => {
          const a = document.createElement("a");
          a.href = p.fileData;
          a.download = p.fileName;
          a.click();
        };

        div.querySelector(".delete-btn").onclick = () => {
          if (confirm("Excluir este projeto?")) {
            let all = JSON.parse(localStorage.getItem("projects"));
            all[currentUser] = all[currentUser].filter(x => x.id !== p.id);
            localStorage.setItem("projects", JSON.stringify(all));
            loadProjects();
          }
        };

        // CORRE√á√ÉO AQUI: editar campos mesmo sem trocar arquivo
        div.querySelector(".edit-btn").onclick = () => {
          const newTitle = prompt("Novo t√≠tulo:", p.title);
          const newAuthor = prompt("Novo autor:", p.author);
          const newDesc = prompt("Nova descri√ß√£o:", p.description);
          const newCategory = prompt("Nova categoria (programacao/engenharia/arquitetura):", p.category);
          const newFormat = prompt("Formato (2D/3D):", p.format);

          const changeFile = confirm("Deseja alterar o arquivo?");
          if (changeFile) {
            const input = document.createElement("input");
            input.type = "file";
            input.onchange = (e) => {
              const file = e.target.files[0];
              const reader = new FileReader();
              reader.onload = () => {
                updateProject(p.id, newTitle, newAuthor, newDesc, newCategory, newFormat, file.name, reader.result);
              };
              reader.readAsDataURL(file);
            };
            input.click();
          } else {
            updateProject(p.id, newTitle, newAuthor, newDesc, newCategory, newFormat, p.fileName, p.fileData);
          }
        };

        projectsGrid.appendChild(div);
      });
    }

    function updateProject(id, title, author, desc, category, format, fileName, fileData) {
      let all = JSON.parse(localStorage.getItem("projects"));
      const projects = all[currentUser];
      const index = projects.findIndex(p => p.id === id);
      if (index > -1) {
        projects[index] = { id, title, author, description: desc, category, format, fileName, fileData };
        localStorage.setItem("projects", JSON.stringify(all));
        loadProjects();
      }
    }

    // ==================== IMPORTA√á√ÉO ====================
    importBtn.addEventListener("click", () => { importFile.dataset.type="arquitetura"; importFile.click(); });
    importEngBtn.addEventListener("click", () => { importFile.dataset.type="engenharia"; importFile.click(); });

    importFile.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const title = prompt(`Nome do projeto de ${importFile.dataset.type}:`);
        if (!title) return;
        const author = prompt("Autor do projeto:") || "Desconhecido";
        const project = { id: Date.now(), title, author, description: "Importado manualmente", category: importFile.dataset.type, format: file.name.endsWith(".glb") || file.name.endsWith(".gltf") ? "3D" : "2D", fileName: file.name, fileData: reader.result };
        saveProject(project);
        alert(`Projeto de ${importFile.dataset.type} importado com sucesso!`);
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
